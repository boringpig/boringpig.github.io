<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>將 Model 分成 4 + 1 部分 - Jeffery Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="「 Model 」並不是一個資料夾的意思，是指除了 View、Controller 之外的所有關於資料存取的邏輯，分為實體關聯(Entity)、顯示邏輯(Presenter)、資料庫邏輯(Repository)、商業邏輯(Service)及資料驗證(Form) 還有許多像是 Package、trait 等等，由於小弟我經驗還不足，所以可以參考其他大大的 blog 像是轉個彎日誌、點燈坊等等。">
<meta property="og:type" content="article">
<meta property="og:title" content="將 Model 分成 4 + 1 部分">
<meta property="og:url" content="http://boringpig.github.io/Laravel/將-Model-分成-4-1-部分/index.html">
<meta property="og:site_name" content="Jeffery Blog">
<meta property="og:description" content="「 Model 」並不是一個資料夾的意思，是指除了 View、Controller 之外的所有關於資料存取的邏輯，分為實體關聯(Entity)、顯示邏輯(Presenter)、資料庫邏輯(Repository)、商業邏輯(Service)及資料驗證(Form) 還有許多像是 Package、trait 等等，由於小弟我經驗還不足，所以可以參考其他大大的 blog 像是轉個彎日誌、點燈坊等等。">
<meta property="og:image" content="http://boringpig.github.io/images/laravel/Laravel5.2.png">
<meta property="og:image" content="https://i.imgur.com/APeLgjY.png">
<meta property="og:image" content="https://i.imgur.com/PEcOX28.png">
<meta property="og:image" content="https://i.imgur.com/fRBP9T4.png">
<meta property="og:image" content="https://i.imgur.com/15UWMZb.png">
<meta property="og:image" content="https://i.imgur.com/YEwqhqF.png">
<meta property="og:image" content="https://i.imgur.com/WWwDw6g.png">
<meta property="og:image" content="https://i.imgur.com/7r9t9ks.png">
<meta property="og:updated_time" content="2016-09-19T06:48:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="將 Model 分成 4 + 1 部分">
<meta name="twitter:description" content="「 Model 」並不是一個資料夾的意思，是指除了 View、Controller 之外的所有關於資料存取的邏輯，分為實體關聯(Entity)、顯示邏輯(Presenter)、資料庫邏輯(Repository)、商業邏輯(Service)及資料驗證(Form) 還有許多像是 Package、trait 等等，由於小弟我經驗還不足，所以可以參考其他大大的 blog 像是轉個彎日誌、點燈坊等等。">
<meta name="twitter:image" content="http://boringpig.github.io/images/laravel/Laravel5.2.png">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  

</head>

<body>
  <div id="container">
    <header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/categories">Categories</a>
        
          <a class="main-nav-link" href="/tags">Tags</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://boringpig.github.io"></form>
        </div>
      </nav>
    </div>
  </div>
</header>
    <section id="main" class="outer"><article id="post-將-Model-分成-4-1-部分" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h4 class="article-title" itemprop="name">
      將 Model 分成 4 + 1 部分
    </h4>
  


      </header>
    
    <div class="article-meta">
      <a href="/Laravel/將-Model-分成-4-1-部分/" class="article-date">
  <time datetime="2016-09-19T04:19:40.000Z" itemprop="datePublished">2016-09-19</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Laravel/">Laravel</a>
  </div>

      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <img src="/images/laravel/Laravel5.2.png" width="650">
<p>「 Model 」並不是一個資料夾的意思，是指除了 View、Controller 之外的所有關於資料存取的邏輯，分為實體關聯(Entity)、顯示邏輯(Presenter)、資料庫邏輯(Repository)、商業邏輯(Service)及資料驗證(Form) 還有許多像是 Package、trait 等等，由於小弟我經驗還不足，所以可以參考其他大大的 blog 像是<a href="http://blog.turn.tw/" target="_blank" rel="external">轉個彎日誌</a>、<a href="http://oomusou.io/" target="_blank" rel="external">點燈坊</a>等等。<br><a id="more"></a></p>
<h1 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h1><p>Laravel 5.2.31</p>
<hr>
<h1 id="Content"><a href="#Content" class="headerlink" title="Content"></a>Content</h1><h2 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h2><p>為資料表的專有名稱，例如：User.php 與 create_users_table.php，class 裡面包括 table 的 name、field 和 relationships，還有 Form 的 accessors 和 mutators。</p>
<p><img src="https://i.imgur.com/APeLgjY.png" alt=""></p>
<div class="alert alert-danger"><i class="fa fa-bug"></i>  如果 Entity 類別存在 scope 方法，會造成類別肥大也不好做測試，所以只要存取資料庫邏輯的部分都交給 Repository。</div>
<h3 id="何謂-accessors-amp-mutators"><a href="#何謂-accessors-amp-mutators" class="headerlink" title="何謂 accessors &amp; mutators?"></a>何謂 accessors &amp; mutators?</h3><p>通常用於新增與修改的表單之中，也就是說當我們讀取和存入到資料庫的資料格式，都是按照我們想要的格式，用法是按照駝峰式的寫法才可以抓取對應到的表單欄位。</p>
<ul>
<li><p>accessors : 從資料庫讀取資料之後轉換成自定義的格式到表單中</p>
<p>以下範例為將表單中 first_name 欄位的值轉換成第一個字大寫</p>
</li>
</ul>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;User.php</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFirstNameAttribute</span><span class="params">($value)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> ucfirst($value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>mutators : 將表單的資料轉換成自定義的格式，儲存至資料庫中</p>
<p>以下範例為將使用者輸入完的表單中 password 欄位的值轉換成 Hash 格式</p>
</li>
</ul>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;User.php</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setPasswordAttribute</span><span class="params">($value)</span> </span>&#123;</div><div class="line">      <span class="keyword">$this</span>-&gt;attributes[<span class="string">'password'</span>] = Hash::make($value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Presenter"><a href="#Presenter" class="headerlink" title="Presenter"></a>Presenter</h2><p>用來處理在 view 裡的資料顯示邏輯，也就是說不要再 view 裡寫 if/else 的判斷會造成複雜難以維護，如果不會使用 pattern 來解決，可以使用 <a href="https://github.com/laracasts/Presenter" target="_blank" rel="external">laracasts/Presenter</a> 這個好用且易上手的套件</p>
<ul>
<li><p>建立關於 Entity 的 presenter 類別寫入資料顯示邏輯</p>
<p>以下範例為判斷使用者的啟用狀態、帳戶類型</p>
<p><img src="https://i.imgur.com/PEcOX28.png" alt=""></p>
</li>
<li><p>將建立的 presenter 插入對應到 Entity 類別</p>
<p><img src="https://i.imgur.com/fRBP9T4.png" alt=""></p>
</li>
<li><p>在 blade 中就會乾淨許多</p>
<p><img src="https://i.imgur.com/15UWMZb.png" alt=""></p>
</li>
</ul>
<h2 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h2><p>用來處理資料庫邏輯，也就是說將所有 query logic 都封裝在這個類別裡面，不僅幫助我們可以做好測試並避免 entity 出現太多 scope 方法，也達到SOLID原則的單一職責分割，讓我們更清楚知道該類別處理的事情</p>
<ul>
<li>由於每個 Repository 都有相同的方法，所以可以建立 abstact class 不用寫重複的 code</li>
</ul>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;AbstractRepository</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Repositories</span>;</div><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</div><div class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Model</span>;</div><div class="line"></div><div class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractRepository</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">/** 注入的model */</span></div><div class="line">	<span class="keyword">protected</span> $model;</div><div class="line">	<span class="comment">/** <span class="doctag">@var</span> string $modelName model名稱 */</span></div><div class="line">	<span class="keyword">protected</span> $modelName;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * AbstractRepository constructor.</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;modelName = get_class(<span class="keyword">$this</span>-&gt;model);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 根據pk找資料</div><div class="line">	 * <span class="doctag">@param</span> $id</div><div class="line">	 * <span class="doctag">@param</span> array $columns</div><div class="line">	 * <span class="doctag">@return</span> mixed</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span><span class="params">($id, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;find($id, $columns);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 根據一般欄位找資料</div><div class="line">	 * <span class="doctag">@param</span> $attribute</div><div class="line">	 * <span class="doctag">@param</span> $value</div><div class="line">	 * <span class="doctag">@param</span> array $columns</div><div class="line">	 * <span class="doctag">@return</span> Model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">findBy</span><span class="params">($attribute, $value, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model</div><div class="line">			-&gt;where($attribute, <span class="string">'='</span>, $value)</div><div class="line">			-&gt;first($columns);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 若存在則傳回 model，若不存在則新增</div><div class="line">	 * <span class="doctag">@param</span> array $data</div><div class="line">	 * <span class="doctag">@return</span> Model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">firstOrCreate</span><span class="params">(array $data)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;firstOrCreate($data);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 回傳全部資料</div><div class="line">	 * <span class="doctag">@param</span> array $columns</div><div class="line">	 * <span class="doctag">@return</span> Collection</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">all</span><span class="params">($columns = [<span class="string">'*'</span>])</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;all($columns);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 回傳分頁資料</div><div class="line">	 * <span class="doctag">@param</span> int $perPage</div><div class="line">	 * <span class="doctag">@param</span> array $columns</div><div class="line">	 * <span class="doctag">@return</span> Collection</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">paginate</span><span class="params">($perPage = <span class="number">15</span>, $columns = [<span class="string">'*'</span>])</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;paginate($perPage, $columns);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 新增資料，傳回 model，不存檔</div><div class="line">	 * <span class="doctag">@param</span> array $data</div><div class="line">	 * <span class="doctag">@return</span> Model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span><span class="params">(array $data)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;modelName($data);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 新增資料，回傳 model，直接存檔</div><div class="line">	 * <span class="doctag">@param</span> array $data</div><div class="line">	 * <span class="doctag">@return</span> Model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">create</span><span class="params">(array $data)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;create($data);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 修改資料，回傳 model，直接存檔</div><div class="line">	 * <span class="doctag">@param</span> array $data</div><div class="line">	 * <span class="doctag">@param</span> $id</div><div class="line">	 * <span class="doctag">@param</span> string $attribute</div><div class="line">	 * <span class="doctag">@return</span> Model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(array $data, $id, $attribute = <span class="string">"id"</span>)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model</div><div class="line">			-&gt;where($attribute, <span class="string">'='</span>, $id)</div><div class="line">			-&gt;update($data);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 刪除資料，回傳 model，直接刪除</div><div class="line">	 * <span class="doctag">@param</span> $id</div><div class="line">	 * <span class="doctag">@return</span> Model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">delete</span><span class="params">($id)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;model-&gt;destroy($id);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>建立 repository 並繼承 abstract class 注入對應的 entity</li>
</ul>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;UserRepository</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">AbstractRepository</span></span></div><div class="line">&#123;</div><div class="line">	<span class="comment">/** <span class="doctag">@var</span> User $model Model物件 */</span></div><div class="line">	<span class="keyword">protected</span> $model;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * UserRepository constructor.</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@param</span> User $model</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $model)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;model = $model;</div><div class="line">		<span class="keyword">parent</span>::__construct();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 回傳所有已啟用的使用者</div><div class="line">	 *</div><div class="line">	 * <span class="doctag">@return</span> Collection</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllUserActivated</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		$users = <span class="keyword">$this</span>-&gt;model-&gt;where(<span class="string">'status'</span>, <span class="keyword">true</span>)</div><div class="line">				      -&gt;orderBy(<span class="string">'created_at'</span>, <span class="string">'desc'</span>)</div><div class="line">				      -&gt;get();</div><div class="line">		<span class="keyword">return</span> $users;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>在 controller 中可以注入 repository 呼叫方法來操作資料庫</p>
<p>以下範例是將 repositroy 注入到 controller (通常是注入到 Service 類別裡)，並使用其中的方法回傳的資料到 blade 裡面顯示出來。。</p>
</li>
</ul>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;UserController</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">UserRepository</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/** <span class="doctag">@var</span>  UserRepository 注入的UserRepository */</span></div><div class="line">    <span class="keyword">protected</span> $userRepository;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * UserController constructor.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> UserRepository $userRepository</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepository $userRepository)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;userRepository = $userRepository;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 顯示所有已啟用的使用者.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> \Illuminate\Http\Response</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></div><div class="line">    &#123;</div><div class="line">        $users = <span class="keyword">$this</span>-&gt;userRepository-&gt;getAllUserActivated();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> view(<span class="string">'users.index'</span>, compact(<span class="string">'users'</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<div class="alert alert-danger"><i class="fa fa-bug"></i>  Laravel 中每個 entity 都繼承 Eloquent 的方法，所以物件可以直接下像是: $user->create()、$user->find() 等直接操作資料庫指令 ，對於小型專案來說還可以;但對於中大型專案來說會變得複雜難以維護。</div>
<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><p>用來處理商業邏輯，也就是說這個類別主要處理多個 entity 之間的複雜行為、外部行為，讓 controller 只負責接收 HTTP Request 及分配方法，是專案中主要用來做測試與重構功能的類別</p>
<ul>
<li><p>新增 service 屬於 entity 的 business logic 並注入 repository</p>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;UserService</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Repositories</span>\<span class="title">UserRepository</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserService</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/** <span class="doctag">@var</span>  UserRepository 注入的UserRepository */</span></div><div class="line">    <span class="keyword">protected</span> $userRepository;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * UserController constructor.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> UserRepository $userRepository</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserRepository $userRepository)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;userRepository = $userRepository;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 重設使用者密碼</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> array $data</div><div class="line">     * <span class="doctag">@param</span> $userObj</div><div class="line">     * <span class="doctag">@return</span> null</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">resetUserPassword</span><span class="params">(array $data, $userObj)</span></span></div><div class="line">    &#123;</div><div class="line">	  $result = <span class="keyword">$this</span>-&gt;userRepository-&gt;updateUserPassword($data, $userObj);</div><div class="line">	  <span class="keyword">if</span> ($result) &#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;logUserAccount(<span class="string">'重設密碼'</span>, <span class="string">'密碼變更成功'</span>, []);</div><div class="line">		Session::flash(<span class="string">'success'</span>, <span class="string">'密碼變更成功'</span>);</div><div class="line">	  &#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;logUserAccount(<span class="string">'重設密碼'</span>, <span class="string">'密碼變更失敗'</span>, []);</div><div class="line">		Session::flash(<span class="string">'error'</span>, <span class="string">'與原本設定的密碼不相符'</span>);</div><div class="line">	  &#125;</div><div class="line">	  <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>將 service 注入到 controller 中，呼叫對應的方法傳入 blade 中</p>
</li>
</ul>
<figure class="highlight php"><figcaption><span>&nbsp;&nbsp;&nbsp;UserController</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Services</span>\<span class="title">UserService</span>;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">/** <span class="doctag">@var</span>  UserService $user */</span></div><div class="line">    <span class="keyword">protected</span> $user;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * UserController constructor.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> UserService $user</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(UserService $user)</span></span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">$this</span>-&gt;user = $user;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">postChangePassword</span><span class="params">(Request $request)</span></span></div><div class="line">    &#123;</div><div class="line">	  $user = Auth::user();</div><div class="line">	  <span class="keyword">$this</span>-&gt;user-&gt;resetUserPassword($request-&gt;except(<span class="string">'_method'</span>,<span class="string">'_token'</span>), $user);</div><div class="line"></div><div class="line">	  <span class="keyword">return</span> redirect()-&gt;back();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<div class="alert alert-danger"><i class="fa fa-bug"></i>  概念上不屬於任何 entity 的 business logic，而是屬於獨立 Service 像是 OrderService、 PriceService 等等。此範例屬於中小型專案所以將 Service 屬於 entity 的 business logic</div>
<h2 id="Form"><a href="#Form" class="headerlink" title="Form"></a>Form</h2><p>用來處理表單的資料驗證，驗證過後才決定是否執行下一步驟</p>
<ul>
<li>新增 Request 類別來驗證資料的格式</li>
</ul>
<p><img src="https://i.imgur.com/YEwqhqF.png" alt=""></p>
<ul>
<li>讓 controller 不要出現冗長的 validation 增加複雜度</li>
</ul>
<p><img src="https://i.imgur.com/WWwDw6g.png" alt=""></p>
<ul>
<li>這樣就完成啦～</li>
</ul>
<p><img src="https://i.imgur.com/7r9t9ks.png" alt=""></p>
<div class="alert alert-success"><i class="fa fa-lightbulb-o"></i>  可以使用 [laravel-jsvalidation](https://github.com/proengsoft/laravel-jsvalidation) 達到前端的驗證效果</div>
<hr>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><h5 id="胖胖Model減重的五個方法"><a href="#胖胖Model減重的五個方法" class="headerlink" title="胖胖Model減重的五個方法"></a><a href="http://slides.com/howtomakeaturn/model#/" target="_blank" rel="external">胖胖Model減重的五個方法</a></h5><h5 id="ARCA架構"><a href="#ARCA架構" class="headerlink" title="ARCA架構"></a><a href="http://blog.turn.tw/?p=2290" target="_blank" rel="external">ARCA架構</a></h5><h5 id="如何使用-Presenter-模式"><a href="#如何使用-Presenter-模式" class="headerlink" title="如何使用 Presenter 模式?"></a><a href="http://oomusou.io/laravel/laravel-presenter/" target="_blank" rel="external">如何使用 Presenter 模式?</a></h5><h5 id="如何使用-Service-模式"><a href="#如何使用-Service-模式" class="headerlink" title="如何使用 Service 模式?"></a><a href="http://oomusou.io/laravel/laravel-service/" target="_blank" rel="external">如何使用 Service 模式?</a></h5><h5 id="如何使用-Repository-模式"><a href="#如何使用-Repository-模式" class="headerlink" title="如何使用 Repository 模式?"></a><a href="http://oomusou.io/laravel/laravel-repository/" target="_blank" rel="external">如何使用 Repository 模式?</a></h5><h5 id="Automatically-Format-Data-Accessors-and-Mutators"><a href="#Automatically-Format-Data-Accessors-and-Mutators" class="headerlink" title="Automatically Format Data Accessors and Mutators"></a><a href="https://scotch.io/tutorials/automatically-format-laravel-database-fields-with-accessors-and-mutators" target="_blank" rel="external">Automatically Format Data Accessors and Mutators</a></h5><hr>

      
    </div>
    
    
      <footer class="article-footer">
        
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Laravel-5-2/">Laravel 5.2</a></li></ul>

      </footer>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/Laravel/Form-Reuse-Model-Binding/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-title"><span>&lt;</span>&nbsp;
        
          Form Reuse &amp; Model Binding
        
      </div>
    </a>
  
  
    <a href="/Laravel/Laravel前置設定/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Laravel前置設定&nbsp;<span>&gt;</span></div>
    </a>
  
</nav>

  
</article>




<div class="share_addthis">
  <div class="sharing addthis_toolbox share">
    <a class="addthis_button_facebook_like"></a>
    <a class="addthis_button_tweet"></a>
    <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-560c64c35486b3d4" async="async"></script>
</div>





</section>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.min.js"></script>

  </div>
</body>
</html>
